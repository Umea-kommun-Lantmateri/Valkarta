"use strict";var monader=["januari","februari","mars","april","maj","juni","juli","augusti","september","oktober","november","december"],dagar=["Söndag","Måndag","Tisdag","Onsdag","Torsdag","Fredag","Lördag"],app=function(){function n(){this.FilterButton=null;this.Filtering=!1;this.Selection=null;this.SelectionCollection=null;this.Results=[]}return n.prototype.init=function(){console.log("init");this.BaseUrl=location.host.indexOf("localhost")>-1?"/":"/valkarta/";this.CreateMap();this.HideMarker();this.initEvents()},n.prototype.CreateMap=function(){map.AddLayer("WMS",map.WMS.getWMS({Layer:"Projektkarta_V2",Projection:ol.proj.get("EPSG:3006"),ZoomRange:20,Resolutions:[3532.8773948498006,1766.4386974249003,883.21934871245014,441.60967435622507,220.80483717811254,110.40241858905627,55.201209294528134,27.600604647264067,13.800302323632034,6.9001511618160167,3.4500755809080084,1.7250377904540042,.86251889522700209,.431259447613501,.2156297238067505,.1078148619033753,.0539074309516876,.0269537154758438,.0134768577379219,.006738428868961,.0033692144344805]}));this.AddGeoJson("data/vallokaler.json","punkter");this.AddGeoJson("data/valdistrikt.json","valdistrikt");map.AddLayer("Adress",new ol.layer.Vector({source:new ol.source.Vector,style:a.StyleFunction}));map.CreateMap("map",13,0,map.GetProjection("SWEREF 99 TM"),!0);map.setCenter([758621.56504060142,7088235.9311803626],map.GetProjection("SWEREF 99 TM"));map.setZoom(7);map.GetMap().getView().setMaxZoom(15);document.getElementById("ZoomPlus").addEventListener("click",function(){map.ZoomIn()});document.getElementById("ZoomMinus").addEventListener("click",function(){map.ZoonOut()})},n.prototype.initFilter=function(){for(var n=this,i=document.querySelectorAll("#Filter .item"),t=0;t<i.length;t++)i[t].addEventListener("click",function(t){var i=t.target;i.localName!=="button"&&(i=i.parentElement);n.FilterButton===t.target?(n.FilterButton.classList.remove("on"),n.Filtering=!1,n.OnlyShow(""),n.FilterButton=null,document.getElementById("FilterShowAll").classList.remove("show")):(n.Filtering=!0,n.OnlyShow(i.getAttribute("data-type")),i.classList.add("on"),n.FilterButton&&n.FilterButton.classList.remove("on"),n.FilterButton=i,document.getElementById("FilterShowAll").classList.add("show"));window.innerWidth<=876&&document.getElementById("Filter").classList.remove("show");document.getElementById("FilterCloseArea").classList.remove("show")});document.getElementById("FilterButton").addEventListener("click",function(){document.getElementById("Filter").classList.add("show");document.getElementById("FilterCloseArea").classList.add("show")});document.getElementById("FilterCloseArea").addEventListener("click",function(){document.getElementById("Filter").classList.remove("show");document.getElementById("FilterCloseArea").classList.remove("show")});document.getElementById("FilterShowAll").addEventListener("click",function(){n.FilterButton.classList.remove("on");n.Filtering=!1;n.OnlyShow("");n.FilterButton=null;document.getElementById("FilterShowAll").classList.remove("show")})},n.prototype.initEvents=function(){for(var n=this,i=document.querySelectorAll(".CloseInfroScreen"),t=0;t<i.length;t++)i[t].addEventListener("click",function(){n.CloseInfroScreen()});this.Selection=new ol.interaction.Select({condition:ol.events.condition.click,layers:[map.GetLayer("punkter")],style:new ol.style.Style({image:new ol.style.Circle({radius:10,fill:new ol.style.Fill({color:"#AA1F7D"}),stroke:new ol.style.Stroke({color:"#000",width:2})})})});map.addInteraction(this.Selection);this.SelectionCollection=this.Selection.getFeatures();this.SelectionCollection.on("add",function(){n.SelectionCollection.forEach(function(t){n.ShowMarker(t)})});this.SelectionCollection.on("remove",function(){n.HideMarker()});document.getElementById("HittaButton").addEventListener("click",function(){document.getElementById("Find").classList.add("show")});document.getElementById("CloseFind").addEventListener("click",function(){document.getElementById("Find").classList.remove("show")});document.getElementById("FindSearch").addEventListener("input",function(){n.Search(document.querySelector("#FindSearch").value,"SearchResults")});document.getElementById("FindSearch").addEventListener("keyup",function(n){var i,t;if(console.log(n),n.keyCode===40)for(i=document.getElementById("SearchResults").getElementsByTagName("li"),t=0;t<i.length;t++){i[t].focus();break}});document.getElementById("FindSearch2").addEventListener("input",function(){n.Search(document.querySelector("#FindSearch2").value,"SearchResults2")})},n.prototype.OnlyShow=function(n){for(var i,t,r=1;r<map.settings.layers.length;r++){if(i=map.settings.layers[r].layer.getSource().getFeatures(),n==="")for(t=0;t<i.length;t++)i[t].set("FilterSymbol","");else for(t=0;t<i.length;t++)i[t].get("Symbol").indexOf(n)>-1?i[t].set("FilterSymbol",n):i[t].set("FilterSymbol","");map.settings.layers[r].layer.getSource().refresh()}},n.prototype.StyleFunction=function(n){if(n.getGeometry().getType()==="Point")return n.getProperties().adress?[new ol.style.Style({image:new ol.style.Circle({radius:10,fill:new ol.style.Fill({color:"#079592"})})})]:[new ol.style.Style({image:new ol.style.Circle({radius:10,fill:new ol.style.Fill({color:"#AA1F7D"})})})]},n.prototype.AddGeoJson=function(n,t){map.AddLayer(t,new ol.layer.Vector({source:new ol.source.Vector({format:new ol.format.GeoJSON,url:this.BaseUrl+n}),style:a.StyleFunction}));map.GetLayer(t).getSource().on("change",function(){var r,i,n;if(map.GetLayer(t).getSource().getState()==="ready")for(r=map.GetLayer(t).getSource(),i=r.getFeatures(),n=0;n<i.length;n++)i[n].set("Layer",t)})},n.prototype.CloseInfroScreen=function(){document.getElementById("InfroScreen").classList.remove("open")},n.prototype.ShowMarker=function(n){var y=this,t,r,f,e,o,s,h,c,i,l,u,a,v;console.log(n);t=document.createDocumentFragment();r=document.createElement("button");r.innerText="X";r.classList.add("CloseMarker");r.addEventListener("click",function(){y.HideMarker()});t.appendChild(r);f=document.createElement("h3");f.innerText=n.get("Vallokalnamn");t.appendChild(f);e=document.createElement("h4");e.innerText=n.get("Adress");t.appendChild(e);o=document.createElement("h4");o.innerHTML="<h3><u>När du ska rösta: <\/u><\/h3><br><p>Ta med id-handling och ditt röstkort.<br>På röstkortet finns mer information.<\/p>";t.appendChild(o);s=document.createElement("a");s.innerHTML="<a href='http://www.umea.se/val' target='_blank'>www.umea.se/val<\/a>  ";t.appendChild(s);h=document.createElement("h4");h.innerText="Öppettider för lokalen finns nedan";t.appendChild(h);c=!1;for(i in n.getProperties())i.split("_")[0]==="Datum"&&(l=document.createElement("h3"),u=new Date(i.split("_")[1].substr(0,4)+"-"+i.split("_")[1].substr(4,2)+"-"+i.split("_")[1].substr(6,2)),u.getTime()>(new Date).getTime()&&(l.innerText=dagar[u.getDay()]+" "+u.getDate()+" "+monader[u.getMonth()],t.appendChild(l),a=document.createElement("p"),a.innerText=n.getProperties()[i],t.appendChild(a),c=!0));c===!1&&(v=document.createElement("p"),v.innerText="Det finns inga öppna dagar för den här lokalen.",t.appendChild(v));document.getElementById("Markerinfo").innerHTML="";document.getElementById("Markerinfo").appendChild(t);document.querySelector("#Markerinfo").classList.add("show")},n.prototype.HideMarker=function(){this.SelectionCollection&&this.SelectionCollection.clear();document.querySelector("#Markerinfo").classList.remove("show")},n.prototype.capitaliseAddresses=function(n){function r(n){return n.charAt(0).toUpperCase()+n.slice(1)}var i,t;for(n=n.toLowerCase(),i=n.split(" "),n="",t=0;t<i.length;t++)n+=r(i[t])+" ";return n},n.prototype.capitaliseFirstLetter=function(n){return n.charAt(0).toUpperCase()+n.slice(1)},n.prototype.Search=function(n,t){var i=this;console.log("Search:",n);network.GET(this.BaseUrl+"api/Search?query="+n,function(n){var f,u,r,e;for(i.Results=n,console.log(n),document.getElementById(t).innerHTML="",f=document.createElement("ul"),u=0;u<n.length;u++)r=document.createElement("li"),r.setAttribute("data-id",u.toString()),r.setAttribute("tabindex",(10+u).toString()),r.innerText=i.capitaliseAddresses(n[u].adr.toLowerCase()),e=document.createElement("span"),e.innerText=i.capitaliseFirstLetter(n[u].ort),r.appendChild(e),r.addEventListener("click",function(){a.GoToAdress(parseInt(this.getAttribute("data-id")))}),r.addEventListener("keyup",function(n){var e=this.tabIndex,i=document.getElementById(t).getElementsByTagName("li"),u,r,f;if(n.keyCode===40)for(r=!1,u=0;u<i.length;u++){if(r){i[u].focus();break}e===i[u].tabIndex&&(r=!0)}else if(n.keyCode===38)for(r=!1,f=i.length-1;f>=0;f--){if(r){i[f].focus();break}e===i[f].tabIndex&&(r=!0)}else n.keyCode===13&&a.GoToAdress(parseInt(this.getAttribute("data-id")))}),f.appendChild(r);document.getElementById(t).appendChild(f)},function(){})},n.prototype.GoToAdress=function(n){var h=this.Results[n],f,e,o,r,u,c,t,i,l,s;for(this.DinAdressOverlay&&(map.GetMap().removeOverlay(this.DinAdressOverlay),map.GetMap().removeOverlay(this.DinVallokalOverlay)),document.getElementById("Find").classList.remove("show"),document.getElementById("InfroScreen").classList.remove("open"),f=proj4("EPSG:4326","EPSG:3006",[h.lon,h.lat]),e=document.createElement("div"),e.classList.add("DinAdress"),e.innerText="Din adress",this.DinAdressOverlay=new ol.Overlay({position:f,positioning:"bottom-center",element:e}),map.GetMap().addOverlay(this.DinAdressOverlay),o=map.GetLayer("valdistrikt").getSource().getFeatures(),r=map.GetLayer("punkter").getSource().getFeatures(),u=0;u<o.length;u++)if(o[u].getGeometry().intersectsCoordinate(f))for(c=o[u].getProperties().VD_NAMN,t=0;t<r.length;t++)if(i=r[t].getProperties().Valdistriktsnamn,isNaN(i.substr(0))!==!1&&(i=i.substr(4),i=i.trim()),i===c){this.SelectionCollection.push(r[t]);l=ol.extent.boundingExtent([r[t].getGeometry().getCoordinates(),f]);map.GetMap().getView().fit(l,{padding:[35,35,screen.height/2+35,35]});s=document.createElement("div");s.classList.add("Dinvallokal");s.innerText="Din vallokal";this.DinVallokalOverlay=new ol.Overlay({position:r[t].getGeometry().getCoordinates(),positioning:"bottom-center",element:s,offset:[0,-20]});map.GetMap().addOverlay(this.DinVallokalOverlay);break}},n}(),a=new app;a.init();